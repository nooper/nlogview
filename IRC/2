<?php
include('../nlogview.php');

class IRC extends nLogView
{
	private $html;
	private $childhtml;
	protected $db;

	public function getContent()
	{
		$myhtml = '
			<table>
			<tr>
			<td>
			<a href="">Servers</a>
			| Nicknames 
			| Users 
			| Hosts 
			| <a href="?action=showlogs">Logs</a>
			<tr><td>
			'
			. $this->childhtml .
			'
			</tr></td>
			</td>
			</tr>
			</table>
			';

		parent::addChildContent($myhtml);
		return parent::getContent();
	}

	public function addChildContent($value)
	{
		$this->childhtml .= $value;
	}

	public function getLogs()
	{
		$logdata = array();
		$q = $this->db->query('SELECT * FROM nlogview_logs');
		while($row = $q->fetchRow(DB_FETCHMODE_ASSOC))
		{
			$logdata[] = array(
				'name' => $row['name'],
				'source' => $row['source'],
				'timestamp' => $row['submittime']
			);
		}
		return $logdata;
	}

	public function getServers()
	{
		$serverdata = array();
		$q = $this->db->query('SELECT * FROM nlogview_servers');
		while($row = $q->fetchRow(DB_FETCHMODE_ASSOC))
		{
			$serverdata[] = array(
				'name' => $row['name'],
				'address' => $row['address']
			);
		}
		return $serverdata;
	}

	public function readLogFile($path, $type, $name)
	{
		$retstr = "";
		if($type == 'irssi')
		{
			$logfile = fopen($path, 'r');
			while(!feof($logfile))
			{
				$line = fgets($logfile);
				if(ereg("^[0-9]2:[0-9]2", $line))
				{
					if(ereg("joined", $line))
					{
						ereg("^[0-9]2:[0-9]2 -!- ([^ ]*).*has joined", $line, $regs);
						$retstr .= $regs[0] . "<br>";
					}
				}
				else
				{
					$retstr .= $line . "--BAD!<br>";
				}
			}
		}
		return $retstr;
	}

}

?>
